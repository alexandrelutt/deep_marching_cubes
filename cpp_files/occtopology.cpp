#include <torch/extension.h>
#include <torch/torch.h>
#include <iostream>
#include <vector>

const int T = 256;

static int occTable[256][8] = {{ 0,  0,  0,  0,  0,  0,  0,  0 },
       { 1,  0,  0,  0,  0,  0,  0,  0 },
       { 0,  1,  0,  0,  0,  0,  0,  0 },
       { 1,  1,  0,  0,  0,  0,  0,  0 },
       { 0,  0,  1,  0,  0,  0,  0,  0 },
       { 1,  0,  1,  0,  0,  0,  0,  0 },
       { 0,  1,  1,  0,  0,  0,  0,  0 },
       { 1,  1,  1,  0,  0,  0,  0,  0 },
       { 0,  0,  0,  1,  0,  0,  0,  0 },
       { 1,  0,  0,  1,  0,  0,  0,  0 },
       { 0,  1,  0,  1,  0,  0,  0,  0 },
       { 1,  1,  0,  1,  0,  0,  0,  0 },
       { 0,  0,  1,  1,  0,  0,  0,  0 },
       { 1,  0,  1,  1,  0,  0,  0,  0 },
       { 0,  1,  1,  1,  0,  0,  0,  0 },
       { 1,  1,  1,  1,  0,  0,  0,  0 },
       { 0,  0,  0,  0,  1,  0,  0,  0 },
       { 1,  0,  0,  0,  1,  0,  0,  0 },
       { 0,  1,  0,  0,  1,  0,  0,  0 },
       { 1,  1,  0,  0,  1,  0,  0,  0 },
       { 0,  0,  1,  0,  1,  0,  0,  0 },
       { 1,  0,  1,  0,  1,  0,  0,  0 },
       { 0,  1,  1,  0,  1,  0,  0,  0 },
       { 1,  1,  1,  0,  1,  0,  0,  0 },
       { 0,  0,  0,  1,  1,  0,  0,  0 },
       { 1,  0,  0,  1,  1,  0,  0,  0 },
       { 0,  1,  0,  1,  1,  0,  0,  0 },
       { 1,  1,  0,  1,  1,  0,  0,  0 },
       { 0,  0,  1,  1,  1,  0,  0,  0 },
       { 1,  0,  1,  1,  1,  0,  0,  0 },
       { 0,  1,  1,  1,  1,  0,  0,  0 },
       { 1,  1,  1,  1,  1,  0,  0,  0 },
       { 0,  0,  0,  0,  0,  1,  0,  0 },
       { 1,  0,  0,  0,  0,  1,  0,  0 },
       { 0,  1,  0,  0,  0,  1,  0,  0 },
       { 1,  1,  0,  0,  0,  1,  0,  0 },
       { 0,  0,  1,  0,  0,  1,  0,  0 },
       { 1,  0,  1,  0,  0,  1,  0,  0 },
       { 0,  1,  1,  0,  0,  1,  0,  0 },
       { 1,  1,  1,  0,  0,  1,  0,  0 },
       { 0,  0,  0,  1,  0,  1,  0,  0 },
       { 1,  0,  0,  1,  0,  1,  0,  0 },
       { 0,  1,  0,  1,  0,  1,  0,  0 },
       { 1,  1,  0,  1,  0,  1,  0,  0 },
       { 0,  0,  1,  1,  0,  1,  0,  0 },
       { 1,  0,  1,  1,  0,  1,  0,  0 },
       { 0,  1,  1,  1,  0,  1,  0,  0 },
       { 1,  1,  1,  1,  0,  1,  0,  0 },
       { 0,  0,  0,  0,  1,  1,  0,  0 },
       { 1,  0,  0,  0,  1,  1,  0,  0 },
       { 0,  1,  0,  0,  1,  1,  0,  0 },
       { 1,  1,  0,  0,  1,  1,  0,  0 },
       { 0,  0,  1,  0,  1,  1,  0,  0 },
       { 1,  0,  1,  0,  1,  1,  0,  0 },
       { 0,  1,  1,  0,  1,  1,  0,  0 },
       { 1,  1,  1,  0,  1,  1,  0,  0 },
       { 0,  0,  0,  1,  1,  1,  0,  0 },
       { 1,  0,  0,  1,  1,  1,  0,  0 },
       { 0,  1,  0,  1,  1,  1,  0,  0 },
       { 1,  1,  0,  1,  1,  1,  0,  0 },
       { 0,  0,  1,  1,  1,  1,  0,  0 },
       { 1,  0,  1,  1,  1,  1,  0,  0 },
       { 0,  1,  1,  1,  1,  1,  0,  0 },
       { 1,  1,  1,  1,  1,  1,  0,  0 },
       { 0,  0,  0,  0,  0,  0,  1,  0 },
       { 1,  0,  0,  0,  0,  0,  1,  0 },
       { 0,  1,  0,  0,  0,  0,  1,  0 },
       { 1,  1,  0,  0,  0,  0,  1,  0 },
       { 0,  0,  1,  0,  0,  0,  1,  0 },
       { 1,  0,  1,  0,  0,  0,  1,  0 },
       { 0,  1,  1,  0,  0,  0,  1,  0 },
       { 1,  1,  1,  0,  0,  0,  1,  0 },
       { 0,  0,  0,  1,  0,  0,  1,  0 },
       { 1,  0,  0,  1,  0,  0,  1,  0 },
       { 0,  1,  0,  1,  0,  0,  1,  0 },
       { 1,  1,  0,  1,  0,  0,  1,  0 },
       { 0,  0,  1,  1,  0,  0,  1,  0 },
       { 1,  0,  1,  1,  0,  0,  1,  0 },
       { 0,  1,  1,  1,  0,  0,  1,  0 },
       { 1,  1,  1,  1,  0,  0,  1,  0 },
       { 0,  0,  0,  0,  1,  0,  1,  0 },
       { 1,  0,  0,  0,  1,  0,  1,  0 },
       { 0,  1,  0,  0,  1,  0,  1,  0 },
       { 1,  1,  0,  0,  1,  0,  1,  0 },
       { 0,  0,  1,  0,  1,  0,  1,  0 },
       { 1,  0,  1,  0,  1,  0,  1,  0 },
       { 0,  1,  1,  0,  1,  0,  1,  0 },
       { 1,  1,  1,  0,  1,  0,  1,  0 },
       { 0,  0,  0,  1,  1,  0,  1,  0 },
       { 1,  0,  0,  1,  1,  0,  1,  0 },
       { 0,  1,  0,  1,  1,  0,  1,  0 },
       { 1,  1,  0,  1,  1,  0,  1,  0 },
       { 0,  0,  1,  1,  1,  0,  1,  0 },
       { 1,  0,  1,  1,  1,  0,  1,  0 },
       { 0,  1,  1,  1,  1,  0,  1,  0 },
       { 1,  1,  1,  1,  1,  0,  1,  0 },
       { 0,  0,  0,  0,  0,  1,  1,  0 },
       { 1,  0,  0,  0,  0,  1,  1,  0 },
       { 0,  1,  0,  0,  0,  1,  1,  0 },
       { 1,  1,  0,  0,  0,  1,  1,  0 },
       { 0,  0,  1,  0,  0,  1,  1,  0 },
       { 1,  0,  1,  0,  0,  1,  1,  0 },
       { 0,  1,  1,  0,  0,  1,  1,  0 },
       { 1,  1,  1,  0,  0,  1,  1,  0 },
       { 0,  0,  0,  1,  0,  1,  1,  0 },
       { 1,  0,  0,  1,  0,  1,  1,  0 },
       { 0,  1,  0,  1,  0,  1,  1,  0 },
       { 1,  1,  0,  1,  0,  1,  1,  0 },
       { 0,  0,  1,  1,  0,  1,  1,  0 },
       { 1,  0,  1,  1,  0,  1,  1,  0 },
       { 0,  1,  1,  1,  0,  1,  1,  0 },
       { 1,  1,  1,  1,  0,  1,  1,  0 },
       { 0,  0,  0,  0,  1,  1,  1,  0 },
       { 1,  0,  0,  0,  1,  1,  1,  0 },
       { 0,  1,  0,  0,  1,  1,  1,  0 },
       { 1,  1,  0,  0,  1,  1,  1,  0 },
       { 0,  0,  1,  0,  1,  1,  1,  0 },
       { 1,  0,  1,  0,  1,  1,  1,  0 },
       { 0,  1,  1,  0,  1,  1,  1,  0 },
       { 1,  1,  1,  0,  1,  1,  1,  0 },
       { 0,  0,  0,  1,  1,  1,  1,  0 },
       { 1,  0,  0,  1,  1,  1,  1,  0 },
       { 0,  1,  0,  1,  1,  1,  1,  0 },
       { 1,  1,  0,  1,  1,  1,  1,  0 },
       { 0,  0,  1,  1,  1,  1,  1,  0 },
       { 1,  0,  1,  1,  1,  1,  1,  0 },
       { 0,  1,  1,  1,  1,  1,  1,  0 },
       { 1,  1,  1,  1,  1,  1,  1,  0 },
       { 0,  0,  0,  0,  0,  0,  0,  1 },
       { 1,  0,  0,  0,  0,  0,  0,  1 },
       { 0,  1,  0,  0,  0,  0,  0,  1 },
       { 1,  1,  0,  0,  0,  0,  0,  1 },
       { 0,  0,  1,  0,  0,  0,  0,  1 },
       { 1,  0,  1,  0,  0,  0,  0,  1 },
       { 0,  1,  1,  0,  0,  0,  0,  1 },
       { 1,  1,  1,  0,  0,  0,  0,  1 },
       { 0,  0,  0,  1,  0,  0,  0,  1 },
       { 1,  0,  0,  1,  0,  0,  0,  1 },
       { 0,  1,  0,  1,  0,  0,  0,  1 },
       { 1,  1,  0,  1,  0,  0,  0,  1 },
       { 0,  0,  1,  1,  0,  0,  0,  1 },
       { 1,  0,  1,  1,  0,  0,  0,  1 },
       { 0,  1,  1,  1,  0,  0,  0,  1 },
       { 1,  1,  1,  1,  0,  0,  0,  1 },
       { 0,  0,  0,  0,  1,  0,  0,  1 },
       { 1,  0,  0,  0,  1,  0,  0,  1 },
       { 0,  1,  0,  0,  1,  0,  0,  1 },
       { 1,  1,  0,  0,  1,  0,  0,  1 },
       { 0,  0,  1,  0,  1,  0,  0,  1 },
       { 1,  0,  1,  0,  1,  0,  0,  1 },
       { 0,  1,  1,  0,  1,  0,  0,  1 },
       { 1,  1,  1,  0,  1,  0,  0,  1 },
       { 0,  0,  0,  1,  1,  0,  0,  1 },
       { 1,  0,  0,  1,  1,  0,  0,  1 },
       { 0,  1,  0,  1,  1,  0,  0,  1 },
       { 1,  1,  0,  1,  1,  0,  0,  1 },
       { 0,  0,  1,  1,  1,  0,  0,  1 },
       { 1,  0,  1,  1,  1,  0,  0,  1 },
       { 0,  1,  1,  1,  1,  0,  0,  1 },
       { 1,  1,  1,  1,  1,  0,  0,  1 },
       { 0,  0,  0,  0,  0,  1,  0,  1 },
       { 1,  0,  0,  0,  0,  1,  0,  1 },
       { 0,  1,  0,  0,  0,  1,  0,  1 },
       { 1,  1,  0,  0,  0,  1,  0,  1 },
       { 0,  0,  1,  0,  0,  1,  0,  1 },
       { 1,  0,  1,  0,  0,  1,  0,  1 },
       { 0,  1,  1,  0,  0,  1,  0,  1 },
       { 1,  1,  1,  0,  0,  1,  0,  1 },
       { 0,  0,  0,  1,  0,  1,  0,  1 },
       { 1,  0,  0,  1,  0,  1,  0,  1 },
       { 0,  1,  0,  1,  0,  1,  0,  1 },
       { 1,  1,  0,  1,  0,  1,  0,  1 },
       { 0,  0,  1,  1,  0,  1,  0,  1 },
       { 1,  0,  1,  1,  0,  1,  0,  1 },
       { 0,  1,  1,  1,  0,  1,  0,  1 },
       { 1,  1,  1,  1,  0,  1,  0,  1 },
       { 0,  0,  0,  0,  1,  1,  0,  1 },
       { 1,  0,  0,  0,  1,  1,  0,  1 },
       { 0,  1,  0,  0,  1,  1,  0,  1 },
       { 1,  1,  0,  0,  1,  1,  0,  1 },
       { 0,  0,  1,  0,  1,  1,  0,  1 },
       { 1,  0,  1,  0,  1,  1,  0,  1 },
       { 0,  1,  1,  0,  1,  1,  0,  1 },
       { 1,  1,  1,  0,  1,  1,  0,  1 },
       { 0,  0,  0,  1,  1,  1,  0,  1 },
       { 1,  0,  0,  1,  1,  1,  0,  1 },
       { 0,  1,  0,  1,  1,  1,  0,  1 },
       { 1,  1,  0,  1,  1,  1,  0,  1 },
       { 0,  0,  1,  1,  1,  1,  0,  1 },
       { 1,  0,  1,  1,  1,  1,  0,  1 },
       { 0,  1,  1,  1,  1,  1,  0,  1 },
       { 1,  1,  1,  1,  1,  1,  0,  1 },
       { 0,  0,  0,  0,  0,  0,  1,  1 },
       { 1,  0,  0,  0,  0,  0,  1,  1 },
       { 0,  1,  0,  0,  0,  0,  1,  1 },
       { 1,  1,  0,  0,  0,  0,  1,  1 },
       { 0,  0,  1,  0,  0,  0,  1,  1 },
       { 1,  0,  1,  0,  0,  0,  1,  1 },
       { 0,  1,  1,  0,  0,  0,  1,  1 },
       { 1,  1,  1,  0,  0,  0,  1,  1 },
       { 0,  0,  0,  1,  0,  0,  1,  1 },
       { 1,  0,  0,  1,  0,  0,  1,  1 },
       { 0,  1,  0,  1,  0,  0,  1,  1 },
       { 1,  1,  0,  1,  0,  0,  1,  1 },
       { 0,  0,  1,  1,  0,  0,  1,  1 },
       { 1,  0,  1,  1,  0,  0,  1,  1 },
       { 0,  1,  1,  1,  0,  0,  1,  1 },
       { 1,  1,  1,  1,  0,  0,  1,  1 },
       { 0,  0,  0,  0,  1,  0,  1,  1 },
       { 1,  0,  0,  0,  1,  0,  1,  1 },
       { 0,  1,  0,  0,  1,  0,  1,  1 },
       { 1,  1,  0,  0,  1,  0,  1,  1 },
       { 0,  0,  1,  0,  1,  0,  1,  1 },
       { 1,  0,  1,  0,  1,  0,  1,  1 },
       { 0,  1,  1,  0,  1,  0,  1,  1 },
       { 1,  1,  1,  0,  1,  0,  1,  1 },
       { 0,  0,  0,  1,  1,  0,  1,  1 },
       { 1,  0,  0,  1,  1,  0,  1,  1 },
       { 0,  1,  0,  1,  1,  0,  1,  1 },
       { 1,  1,  0,  1,  1,  0,  1,  1 },
       { 0,  0,  1,  1,  1,  0,  1,  1 },
       { 1,  0,  1,  1,  1,  0,  1,  1 },
       { 0,  1,  1,  1,  1,  0,  1,  1 },
       { 1,  1,  1,  1,  1,  0,  1,  1 },
       { 0,  0,  0,  0,  0,  1,  1,  1 },
       { 1,  0,  0,  0,  0,  1,  1,  1 },
       { 0,  1,  0,  0,  0,  1,  1,  1 },
       { 1,  1,  0,  0,  0,  1,  1,  1 },
       { 0,  0,  1,  0,  0,  1,  1,  1 },
       { 1,  0,  1,  0,  0,  1,  1,  1 },
       { 0,  1,  1,  0,  0,  1,  1,  1 },
       { 1,  1,  1,  0,  0,  1,  1,  1 },
       { 0,  0,  0,  1,  0,  1,  1,  1 },
       { 1,  0,  0,  1,  0,  1,  1,  1 },
       { 0,  1,  0,  1,  0,  1,  1,  1 },
       { 1,  1,  0,  1,  0,  1,  1,  1 },
       { 0,  0,  1,  1,  0,  1,  1,  1 },
       { 1,  0,  1,  1,  0,  1,  1,  1 },
       { 0,  1,  1,  1,  0,  1,  1,  1 },
       { 1,  1,  1,  1,  0,  1,  1,  1 },
       { 0,  0,  0,  0,  1,  1,  1,  1 },
       { 1,  0,  0,  0,  1,  1,  1,  1 },
       { 0,  1,  0,  0,  1,  1,  1,  1 },
       { 1,  1,  0,  0,  1,  1,  1,  1 },
       { 0,  0,  1,  0,  1,  1,  1,  1 },
       { 1,  0,  1,  0,  1,  1,  1,  1 },
       { 0,  1,  1,  0,  1,  1,  1,  1 },
       { 1,  1,  1,  0,  1,  1,  1,  1 },
       { 0,  0,  0,  1,  1,  1,  1,  1 },
       { 1,  0,  0,  1,  1,  1,  1,  1 },
       { 0,  1,  0,  1,  1,  1,  1,  1 },
       { 1,  1,  0,  1,  1,  1,  1,  1 },
       { 0,  0,  1,  1,  1,  1,  1,  1 },
       { 1,  0,  1,  1,  1,  1,  1,  1 },
       { 0,  1,  1,  1,  1,  1,  1,  1 },
       { 1,  1,  1,  1,  1,  1,  1,  1 }};


static int vertexTable[8][3]={ {0, 1, 0},
			       {1, 1, 0},
			       {1, 0, 0},
                   {0, 0, 0},
			       {0, 1, 1},
			       {1, 1, 1},
			       {1, 0, 1},
                   {0, 0, 1} };

int occupancy_to_topology(torch::Tensor batch_occupancy, torch::Tensor batch_topology){
    int N = batch_occupancy.size(1)-1;

    for (int i=0; i<N; i++){
        for (int j=0; j<N; j++){
            for (int k=0; k<N; k++){
                float p_occ[2][8];
                for (int v=0; v<8; v++){
                    p_occ[0][v] = batch_occupancy.index({i+vertexTable[v][0], j+vertexTable[v][1], k+vertexTable[v][2]}).item<float>();
                    p_occ[1][v] = 1 - p_occ[0][v];
                }
                for (int t=0; t<T; t++){
                    float p = 1.0;
                    for (int v=0; v<8; v++){
                        float new_p = p_occ[occTable[t][v]][v];
                        p *= new_p;
                    }
                    batch_topology.index_put_({i*N*N + j*N + k, t}, p);
                }
            }
        }
    }

    return 1;
}

int occupancy_to_topology_backward(torch::Tensor grad_output, torch::Tensor batch_occupancy, torch::Tensor batch_topology, torch::Tensor grad_occupancy){
    int N = batch_occupancy.size(0)-1;

    for (int i=0; i<N; i++){
        for (int j=0; j<N; j++){
            for (int k=0; k<N; k++){
                float p_occ[2][8];
                for (int v=0; v<8; v++){
                    p_occ[0][v] = batch_occupancy.index({i+vertexTable[v][0], j+vertexTable[v][1], k+vertexTable[v][2]}).item<float>();
                    p_occ[1][v] = 1 - p_occ[0][v];
                }
                for (int t=0; t<T; t++){
                    float grad = grad_output.index({i*N*N + j*N + k, t}).item<float>();
                    for (int v=0; v<8; v++){
                        float curr_grad = grad_occupancy.index({i+vertexTable[v][0], j+vertexTable[v][1], k+vertexTable[v][2]}).item<float>();
                        float sign = -1.0;
                        if (occTable[t][v] == 0){
                            sign = 1.0;
                        }
                        float p = 1.0;
                        for (int v2=0; v2<8; v2++){
                            if (v2 != v){
                                float new_p = p_occ[occTable[t][v2]][v2];
                                p *= new_p;
                            }
                        }
                       grad_occupancy.index_put_({i+vertexTable[v][0], j+vertexTable[v][1], k+vertexTable[v][2]}, curr_grad + sign * grad * p);
                    }               
                }
            }
        }
    }
    return 1;
}

PYBIND11_MODULE(TORCH_EXTENSION_NAME, m) {
  m.def("occupancy_to_topology", &occupancy_to_topology, "Occupancy to Topology");
  m.def("occupancy_to_topology_backward", &occupancy_to_topology_backward, "Occupancy to Topology Backward");
}